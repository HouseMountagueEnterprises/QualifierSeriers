<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Racing Data Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        form {
            max-width: 400px;
            margin: 0 auto;
        }
        label {
            display: block;
            margin-top: 20px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>Horse Racing Data Form</h1>
    <form id="dataForm" onsubmit="submitData(event)">
        <label for="paymentWallet">Payment Wallet:</label>
        <input type="text" id="paymentWallet" name="paymentWallet" required>

        <label for="payoutWallet">Payout Wallet:</label>
        <input type="text" id="payoutWallet" name="payoutWallet" required>

        <label for="txn">Transaction ID (Txn):</label>
        <input type="text" id="txn" name="txn" required>

        <label for="zedSent">Zed Sent:</label>
        <input type="number" id="zedSent" name="zedSent" required>

        <label for="numHorses">Number of Horses:</label>
        <input type="number" id="numHorses" name="numHorses" required>

        <label for="horseIds">Horse IDs (Comma Separated):</label>
        <input type="text" id="horseIds" name="horseIds" required pattern="^(\d+)(,\d+)*$">

        <button type="submit">Submit</button>
    </form>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <!-- Firebase Analytics -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Include Axios for making HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBeNrXc0i73nsWinc9OE6a-BdlIw_1XCAM",
            authDomain: "horse-data-8ece2.firebaseapp.com",
            projectId: "horse-data-8ece2",
            storageBucket: "horse-data-8ece2.appspot.com",
            messagingSenderId: "93061557603",
            appId: "1:93061557603:web:46c557b65ddefd6f273756",
            measurementId: "G-PQR7KH4E3B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore();

        // Blockchain API details (PolygonScan API for Polygon)
        const POLYGONSCAN_API_KEY = 'CT9ZFDJAG135NZ4623TWKQCPZFGXCF45KT';
        const ZED_TOKEN_CONTRACT_ADDRESS = '0x5eC03C1f7fA7FF05EC476d19e34A22eDDb48ACdc'; // Replace with your ZED token contract address

        // Define the cost to register a single horse (in ZED tokens)
        const REGISTRATION_COST_PER_HORSE = 10; // Replace this with the actual cost

        // Function to handle form submission
        async function submitData(event) {
            event.preventDefault();

            // Perform JavaScript validation
            if (!validateForm()) {
                alert('Please fill out all fields correctly.');
                return;
            }

            // Collect form data
            const formData = new FormData(document.getElementById('dataForm'));
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            try {
                // Calculate the expected total registration cost
                const expectedCost = REGISTRATION_COST_PER_HORSE * parseInt(data.numHorses);
                const zedSent = parseFloat(data.zedSent);

                if (zedSent !== expectedCost) {
                    alert(`The amount of ZED sent (${zedSent}) does not match the expected registration cost (${expectedCost}) for ${data.numHorses} horses.`);
                    return;
                }

                // Verify the transaction on the blockchain
                const verificationResult = await verifyTransaction(data.txn, data.paymentWallet, data.payoutWallet, zedSent);

                // If the transaction is verified, save the data
                if (verificationResult.verified) {
                    await saveToLedger(data, verificationResult);
                    alert('Data submitted and verified successfully!');
                    document.getElementById('dataForm').reset();
                } else {
                    alert('Transaction verification failed: ' + verificationResult.reason);
                }
            } catch (error) {
                console.error('Error verifying or saving data: ', error);
                alert('Error verifying transaction or saving data.');
            }
        }

        // Function to validate the form
        function validateForm() {
            const paymentWallet = document.getElementById('paymentWallet').value.trim();
            const payoutWallet = document.getElementById('payoutWallet').value.trim();
            const txn = document.getElementById('txn').value.trim();
            const zedSent = document.getElementById('zedSent').value.trim();
            const numHorses = document.getElementById('numHorses').value.trim();
            const horseIds = document.getElementById('horseIds').value.trim();

            if (!paymentWallet || !payoutWallet || !txn || !zedSent || !numHorses || !horseIds) {
                return false;
            }
            return true;
        }

        // Function to verify the transaction using PolygonScan API
        async function verifyTransaction(txnId, paymentWallet, payoutWallet, amount) {
            try {
                // API call to get transaction details
                const response = await axios.get(`https://api.polygonscan.com/api`, {
                    params: {
                        module: 'account',
                        action: 'tokentx',
                        contractaddress: ZED_TOKEN_CONTRACT_ADDRESS,
                        address: payoutWallet,
                        sort: 'desc',
                        apikey: POLYGONSCAN_API_KEY
                    }
                });

                const transactions = response.data.result;
                // Find the transaction with the matching txnId
                const txn = transactions.find(tx => tx.hash === txnId);

                if (!txn) {
                    return { verified: false, reason: 'Transaction not found' };
                }

                // Verify transaction details
                if (txn.from.toLowerCase() === paymentWallet.toLowerCase() &&
                    txn.to.toLowerCase() === payoutWallet.toLowerCase() &&
                    parseFloat(txn.value) === parseFloat(amount)) {
                    return { verified: true };
                } else {
                    return { verified: false, reason: 'Transaction details do not match' };
                }
            } catch (error) {
                console.error('Error verifying transaction: ', error);
                return { verified: false, reason: 'API error or invalid response' };
            }
        }

        // Function to save verification result to Firestore
        async function saveToLedger(data, verificationResult) {
            data.verification = verificationResult;

            // Split the horse IDs into an array
            const horseIds = data.horseIds.split(',').map(id => id.trim());

            // Create a promise array to store each horse ID entry
            const savePromises = horseIds.map(horseId => {
                const horseData = { ...data, horseId }; // Add horseId to the data
                delete horseData.horseIds; // Remove the original horseIds field

                // Save the data to Firestore
                return db.collection('ledger').add(horseData)
                    .then((docRef) => {
                        console.log('Document written with ID: ', docRef.id);
                    })
                    .catch((error) => {
                        console.error('Error adding document: ', error);
                        throw new Error('Firestore error: ' + error.message);
                    });
            });

            // Wait for all saves to complete
            return Promise.all(savePromises);
        }

        // Attach form submission handler
        document.getElementById('dataForm').addEventListener('submit', submitData);
    </script>

</body>
</html>
