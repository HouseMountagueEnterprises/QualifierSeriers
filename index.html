<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Racing Data Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        form {
            max-width: 400px;
            margin: 0 auto;
        }
        label {
            display: block;
            margin-top: 20px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            margin-top: 20px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>Horse Racing Data Form</h1>
    <form id="dataForm" onsubmit="submitData(event)">
        <label for="paymentWallet">Payment Wallet:</label>
        <input type="text" id="paymentWallet" name="paymentWallet" required>

        <label for="payoutWallet">Payout Wallet:</label>
        <input type="text" id="payoutWallet" name="payoutWallet" required>

        <label for="txn">Transaction ID (Txn):</label>
        <input type="text" id="txn" name="txn" required>

        <label for="zedSent">Zed Sent:</label>
        <input type="number" id="zedSent" name="zedSent" required>

        <label for="numHorses">Number of Horses:</label>
        <input type="number" id="numHorses" name="numHorses" required>

        <label for="horseIds">Horse IDs (Comma Separated):</label>
        <input type="text" id="horseIds" name="horseIds" required pattern="^(\d+)(,\d+)*$">

        <button type="submit">Submit</button>
    </form>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <!-- Firebase Analytics -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Include Axios for making HTTP requests -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBeNrXc0i73nsWinc9OE6a-BdlIw_1XCAM",
            authDomain: "horse-data-8ece2.firebaseapp.com",
            projectId: "horse-data-8ece2",
            storageBucket: "horse-data-8ece2.appspot.com",
            messagingSenderId: "93061557603",
            appId: "1:93061557603:web:46c557b65ddefd6f273756",
            measurementId: "G-PQR7KH4E3B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Blockchain API details (PolygonScan API for Polygon)
        const POLYGONSCAN_API_KEY = 'CT9ZFDJAG135NZ4623TWKQCPZFGXCF45KT';
        const REGISTRATION_WALLET = '0xE9969f9E71eB594381B00d3E7b329D5C8052F5A9'; // Fixed receiving wallet
        const ZED_TOKEN_CONTRACT_ADDRESS = '0x5eC03C1f7fA7FF05EC476d19e34A22eDDb48ACdc'; // ZED token contract address

        // Define the cost to register a single horse (in ZED tokens)
        const REGISTRATION_COST_PER_HORSE = 1;


            // Collect form data
            const formData = new FormData(document.getElementById('dataForm'));
            const data = {};
            formData.forEach((value, key) => data[key] = value);

            try {
                // Calculate the expected total registration cost
                const expectedCost = REGISTRATION_COST_PER_HORSE * parseInt(data.numHorses);
                const zedSent = parseFloat(data.zedSent);

                /*if (zedSent !== expectedCost) {
                    alert(`The amount of ZED sent (${zedSent}) does not match the expected registration cost (${expectedCost}) for ${data.numHorses} horses.`);
                    return;
                }*/

                // Verify the transaction on the blockchain
                const verificationResult = await verifyTransaction(data.txn, data.paymentWallet, REGISTRATION_WALLET, zedSent);

                // If the transaction is verified, save the data
                if (verificationResult.verified) {
                    await saveToLedger({ paymentWallet, payoutWallet, txn, zedSent, numHorses, horseIds }, verificationResult);
                    alert('Data submitted and verified successfully!');
                    document.getElementById('dataForm').reset();
                } else {
                    alert('Transaction verification failed: ' + verificationResult.reason);
                }
            } catch (error) {
                console.error('Error verifying or saving data: ', error);
                alert('Error verifying transaction or saving data.');
            }
        }

              // Validate form data
            const formData = new FormData(document.getElementById('dataForm'));
            const data = {
                paymentWallet: formData.get('paymentWallet'),
                payoutWallet: formData.get('payoutWallet'),
                txn: formData.get('txn'),
                zedSent: parseFloat(formData.get('zedSent')),
                numHorses: parseInt(formData.get('numHorses')),
                horseIds: formData.get('horseIds').split(',').map(id => parseInt(id.trim()))
            };

            // Save data to ledger
            try {
                await saveToLedger(data);
                alert('Data submitted and saved successfully!');
                document.getElementById('dataForm').reset();
            } catch (error) {
                console.error('Error saving data to ledger: ', error);
                alert('Error saving data. Please try again later.');
            }
        }

        // Function to save data to ledger collection
        async function saveToLedger(data) {
            // Check if ledger collection exists, if not, create it
            const ledgerRef = db.collection('ledger');
            const doc = await ledgerRef.doc();
            if (!(await doc.get()).exists) {
                await doc.set({}); // Create the document to automatically create the collection
            }

            // Save data to ledger collection
            await db.collection('ledger').add(data);
        }

      // Function to verify the transaction using PolygonScan API
async function verifyTransaction(txnId, paymentWallet, receivingWallet, amount) {
    try {
        // API call to get transaction details using fetch
        const response = await fetch(`https://api.polygonscan.com/api?module=account&action=tokentx&contractaddress=${ZED_TOKEN_CONTRACT_ADDRESS}&address=${receivingWallet}&sort=desc&apikey=${POLYGONSCAN_API_KEY}`);
        if (!response.ok) {
            throw new Error('Failed to fetch transaction data');
        }
        
        const data = await response.json();
        const transactions = data.result;

        // Find the transaction with the matching txnId
        const txn = transactions.find(tx => tx.hash === txnId);

        if (!txn) {
            return { verified: false, reason: 'Transaction not found' };
        }

        // Convert transaction value based on token decimals
        const tokenValue = parseFloat(txn.value) / Math.pow(10, 18);

        // Verify transaction details
        if (txn.from.toLowerCase() !== paymentWallet.toLowerCase()) {
            return { verified: false, reason: 'Payment wallet does not match' };
        }
        if (txn.to.toLowerCase() !== receivingWallet.toLowerCase()) {
            return { verified: false, reason: 'Receiving wallet does not match' };
        }
        if (tokenValue !== amount) {
            return { verified: false, reason: `Amount sent (${tokenValue}) does not match the expected amount (${amount}) };
        }

        // Return detailed verification result
        return { verified: true };
    } catch (error) {
        console.error('Error verifying transaction: ', error);
        return { verified: false, reason: 'API error or invalid response' };
    }
}

    </script>
</body>
</html>
